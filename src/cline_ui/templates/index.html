{% extends "base.html" %}

{% block title %}Home - Cline UI{% endblock %}

{% block content %}
  <div class="starter-template text-center py-5 px-3">
    <h1>Welcome to Cline UI</h1>
    <p class="lead">Enter your query below to interact with the Cline VS Code extension.</p>
  </div>

  <div class="row">
    <div class="col-md-8 offset-md-2">
      <form id="query-form">
        <input type="hidden" id="task_id" name="task_id">
        <div class="mb-3">
          <label for="query" class="form-label">Query</label>
          <textarea class="form-control" id="query" name="query" rows="3"></textarea>
        </div>
        <div id="resuming-task-alert" class="alert alert-info" style="display: none;">
            Continuing Task ID: <span id="resuming-task-id"></span>
            <button type="button" class="btn-close float-end" aria-label="Close" onclick="clearTaskContext()"></button>
        </div>
        <div class="mb-3">
          <label for="search-options" class="form-label">Search Options</label>
          <input type="text" class="form-control" id="search-options" name="search-options">
        </div>
        <button type="submit" class="btn btn-primary">Submit</button>
      </form>
      <div class="progress mt-3" style="display: none;">
        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
      </div>
    </div>
  </div>

  <div class="row mt-5">
    <div class="col-md-8 offset-md-2">
      <h2>History</h2>
      <div id="history">
        {% for item in history %}
          <div class="card mb-3" data-id="{{ item.id }}">
            <div class="card-body">
              <p class="card-text"><strong>Query:</strong><span class="query-text">{{ item.query }}</span></p>
              <p class="card-text"><strong>Response:</strong><span class="response-text">{{ item.response }}</span></p>
              {% if item.task_id %}
              <p class="card-text"><small class="text-muted">Task ID: {{ item.task_id }}</small></p>
              <button class="btn btn-sm btn-primary" onclick="continueTask('{{ item.task_id }}')">Continue Task</button>
              {% endif %}
              <button class="btn btn-sm btn-secondary" onclick="copyToClipboard(this, '.query-text')">Copy Query</button>
              <button class="btn btn-sm btn-secondary" onclick="copyToClipboard(this, '.response-text')">Copy Response</button>
              <button class="btn btn-sm btn-danger" onclick="deleteHistoryItem(this)">Delete</button>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

{% endblock %}

{% block scripts %}
  <script>
    console.log("Initializing Cline UI scripts...");
    
    // Render Markdown for existing history items
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.response-text').forEach(el => {
            // Only render if it doesn't look like a status update
            if (!el.innerText.startsWith("Processing")) {
                el.innerHTML = DOMPurify.sanitize(marked.parse(el.innerText));
            }
        });
    });

    const toastLiveExample = document.getElementById('liveToast')
    let toast;
    if (toastLiveExample) {
      if (typeof bootstrap !== 'undefined') {
         try {
           toast = new bootstrap.Toast(toastLiveExample)
           console.log("Toast initialized");
         } catch (e) {
           console.error("Failed to initialize toast", e);
         }
      } else {
         console.warn("Bootstrap not defined");
      }
    } else {
      console.warn("Toast element not found");
    }
    
    const progressBar = document.querySelector('.progress');
    const progressBarInner = document.querySelector('.progress-bar');
    let progressInterval;

    function showToast(message) {
      console.log("showToast:", message);
      if (toast) {
        const toastBody = document.querySelector('.toast-body');
        toastBody.textContent = message;
        toast.show()
      } else {
        alert(message);
      }
    }

    function startProgressBar() {
      console.log("Starting progress bar");
      progressBar.style.display = 'block';
      let width = 0;
      progressInterval = setInterval(() => {
        if (width >= 100) {
          clearInterval(progressInterval);
        } else {
          width++;
          progressBarInner.style.width = width + '%';
        }
      }, 600); // 60 seconds / 100
    }

    function resetProgressBar() {
      console.log("Resetting progress bar");
      clearInterval(progressInterval);
      progressBar.style.display = 'none';
      progressBarInner.style.width = '0%';
    }

    const queryForm = document.getElementById('query-form');
    if (queryForm) {
        queryForm.addEventListener('submit', function(e) {
          e.preventDefault();
          console.log("Form submitted");
          const formData = new FormData(this);
          startProgressBar();
          fetch('/query', {
            method: 'POST',
            body: formData
          })
          .then(response => response.json())
          .then(data => {
            console.log("Query response:", data);
            const historyDiv = document.getElementById('history');
            const newEntry = document.createElement('div');
            newEntry.classList.add('card', 'mb-3');
            newEntry.setAttribute('data-id', data.id);
            newEntry.innerHTML = `
              <div class="card-body">
                <p class="card-text"><strong>Query:</strong><span class="query-text">${formData.get('query')}</span></p>
                <p class="card-text"><strong>Response:</strong><span class="response-text">${data.response}</span></p>
                <button class="btn btn-sm btn-secondary" onclick="copyToClipboard(this, '.query-text')">Copy Query</button>
                <button class="btn btn-sm btn-secondary" onclick="copyToClipboard(this, '.response-text')">Copy Response</button>
                <button class="btn btn-sm btn-danger" onclick="deleteHistoryItem(this)">Delete</button>
              </div>
            `;
            historyDiv.prepend(newEntry);
            
            pollForResponse(data.id, newEntry);
          })
          .catch(error => {
            resetProgressBar();
            console.error('Error:', error);
            showToast('An error occurred while starting the query.');
          });
        });
    } else {
        console.error("Query form not found!");
    }

    function pollForResponse(id, cardElement) {
      console.log("Polling for response for id:", id);
      const intervalId = setInterval(() => {
        fetch(`/history/${id}`)
          .then(response => response.json())
          .then(data => {
            // Always update the text to show latest status
            if (data.response) {
                const responseEl = cardElement.querySelector('.response-text');
                if (data.response.startsWith("Processing")) {
                    responseEl.innerText = data.response;
                } else {
                    responseEl.innerHTML = DOMPurify.sanitize(marked.parse(data.response));
                }
            }
            
            // Inject Task ID and Continue button if available and not present
            if (data.task_id && !cardElement.querySelector('.btn-continue-task')) {
                const cardBody = cardElement.querySelector('.card-body');
                const firstButton = cardBody.querySelector('button'); // First existing button
                
                const taskIdP = document.createElement('p');
                taskIdP.className = "card-text";
                taskIdP.innerHTML = `<small class="text-muted">Task ID: ${data.task_id}</small>`;
                
                const continueBtn = document.createElement('button');
                continueBtn.className = "btn btn-sm btn-primary btn-continue-task";
                continueBtn.textContent = "Continue Task";
                continueBtn.onclick = function() { continueTask(data.task_id); };
                
                // Insert before the first button (Copy Query)
                if (firstButton) {
                    cardBody.insertBefore(taskIdP, firstButton);
                    cardBody.insertBefore(continueBtn, firstButton);
                    // Add some spacing/newline if needed, or rely on CSS/block elements
                    // Buttons are inline-block usually. p is block.
                }
            }

            // Check if finished. We consider it finished if it doesn't start with "Processing"
            // This covers "Processing..." (initial) and "Processing: [Status]..." (updates)
            if (data.response && !data.response.startsWith("Processing")) {
              console.log("Poll finished:", data);
              clearInterval(intervalId);
              resetProgressBar();
              showToast('Response received!');
            }
          })
          .catch(error => {
            console.error('Error polling:', error);
            // Don't stop polling on transient errors, but maybe limit retries in a real app
          });
      }, 2000);
    }

    function copyToClipboard(button, textSelector) {
      const card = button.closest('.card-body');
      const text = card.querySelector(textSelector).innerText;
      navigator.clipboard.writeText(text).then(() => {
        showToast('Copied to clipboard!');
      }, (err) => {
        console.error('Could not copy text: ', err);
        showToast('Failed to copy to clipboard.');
      });
    }

    function deleteHistoryItem(button) {
      const card = button.closest('.card');
      const id = card.getAttribute('data-id');
      fetch(`/history/${id}`, {
        method: 'DELETE',
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          card.remove();
          showToast('History item deleted.');
        } else {
          showToast('Failed to delete history item.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast('An error occurred while deleting the history item.');
      });
    }

    function continueTask(taskId) {
        document.getElementById('task_id').value = taskId;
        document.getElementById('resuming-task-id').innerText = taskId;
        document.getElementById('resuming-task-alert').style.display = 'block';
        document.getElementById('query').focus();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function clearTaskContext() {
        document.getElementById('task_id').value = '';
        document.getElementById('resuming-task-alert').style.display = 'none';
    }
  </script>
{% endblock %}
