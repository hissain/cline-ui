{% extends "base.html" %}

{% block title %}Home - Cline UI{% endblock %}

{% block content %}
  <div class="starter-template text-center py-5 px-3">
    <h1>Welcome to Cline UI</h1>
    <p class="lead">Enter your query below to interact with the Cline VS Code extension.</p>
  </div>

  <div class="row">
    <div class="col-md-8 offset-md-2">
      <form id="query-form">
        <div class="mb-3">
          <label for="query" class="form-label">Query</label>
          <textarea class="form-control" id="query" name="query" rows="3"></textarea>
        </div>
        <div class="mb-3">
          <label for="search-options" class="form-label">Search Options</label>
          <input type="text" class="form-control" id="search-options" name="search-options">
        </div>
        <button type="submit" class="btn btn-primary">Submit</button>
      </form>
      <div class="progress mt-3" style="display: none;">
        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
      </div>
    </div>
  </div>

  <div class="row mt-5">
    <div class="col-md-8 offset-md-2">
      <h2>History</h2>
      <div id="history">
        {% for item in history %}
          <div class="card mb-3" data-id="{{ item.id }}">
            <div class="card-body">
              <p class="card-text"><strong>Query:</strong><span class="query-text">{{ item.query }}</span></p>
              <p class="card-text"><strong>Response:</strong><span class="response-text">{{ item.response }}</span></p>
              <button class="btn btn-sm btn-secondary" onclick="copyToClipboard(this, '.query-text')">Copy Query</button>
              <button class="btn btn-sm btn-secondary" onclick="copyToClipboard(this, '.response-text')">Copy Response</button>
              <button class="btn btn-sm btn-danger" onclick="deleteHistoryItem(this)">Delete</button>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

{% endblock %}

{% block scripts %}
  <script>
    console.log("Initializing Cline UI scripts...");
    const toastLiveExample = document.getElementById('liveToast')
    let toast;
    if (toastLiveExample) {
      if (typeof bootstrap !== 'undefined') {
         try {
           toast = new bootstrap.Toast(toastLiveExample)
           console.log("Toast initialized");
         } catch (e) {
           console.error("Failed to initialize toast", e);
         }
      } else {
         console.warn("Bootstrap not defined");
      }
    } else {
      console.warn("Toast element not found");
    }
    
    const progressBar = document.querySelector('.progress');
    const progressBarInner = document.querySelector('.progress-bar');
    let progressInterval;

    function showToast(message) {
      console.log("showToast:", message);
      if (toast) {
        const toastBody = document.querySelector('.toast-body');
        toastBody.textContent = message;
        toast.show()
      } else {
        alert(message);
      }
    }

    function startProgressBar() {
      console.log("Starting progress bar");
      progressBar.style.display = 'block';
      let width = 0;
      progressInterval = setInterval(() => {
        if (width >= 100) {
          clearInterval(progressInterval);
        } else {
          width++;
          progressBarInner.style.width = width + '%';
        }
      }, 600); // 60 seconds / 100
    }

    function resetProgressBar() {
      console.log("Resetting progress bar");
      clearInterval(progressInterval);
      progressBar.style.display = 'none';
      progressBarInner.style.width = '0%';
    }

    const queryForm = document.getElementById('query-form');
    if (queryForm) {
        queryForm.addEventListener('submit', function(e) {
          e.preventDefault();
          console.log("Form submitted");
          const formData = new FormData(this);
          startProgressBar();
          fetch('/query', {
            method: 'POST',
            body: formData
          })
          .then(response => response.json())
          .then(data => {
            console.log("Query response:", data);
            const historyDiv = document.getElementById('history');
            const newEntry = document.createElement('div');
            newEntry.classList.add('card', 'mb-3');
            newEntry.setAttribute('data-id', data.id);
            newEntry.innerHTML = `
              <div class="card-body">
                <p class="card-text"><strong>Query:</strong><span class="query-text">${formData.get('query')}</span></p>
                <p class="card-text"><strong>Response:</strong><span class="response-text">${data.response}</span></p>
                <button class="btn btn-sm btn-secondary" onclick="copyToClipboard(this, '.query-text')">Copy Query</button>
                <button class="btn btn-sm btn-secondary" onclick="copyToClipboard(this, '.response-text')">Copy Response</button>
                <button class="btn btn-sm btn-danger" onclick="deleteHistoryItem(this)">Delete</button>
              </div>
            `;
            historyDiv.prepend(newEntry);
            
            pollForResponse(data.id, newEntry);
          })
          .catch(error => {
            resetProgressBar();
            console.error('Error:', error);
            showToast('An error occurred while starting the query.');
          });
        });
    } else {
        console.error("Query form not found!");
    }

    function pollForResponse(id, cardElement) {
      console.log("Polling for response for id:", id);
      const intervalId = setInterval(() => {
        fetch(`/history/${id}`)
          .then(response => response.json())
          .then(data => {
            // Always update the text to show latest status
            if (data.response) {
                cardElement.querySelector('.response-text').innerText = data.response;
            }

            // Check if finished. We consider it finished if it doesn't start with "Processing"
            // This covers "Processing..." (initial) and "Processing: [Status]..." (updates)
            if (data.response && !data.response.startsWith("Processing")) {
              console.log("Poll finished:", data);
              clearInterval(intervalId);
              resetProgressBar();
              showToast('Response received!');
            }
          })
          .catch(error => {
            console.error('Error polling:', error);
            // Don't stop polling on transient errors, but maybe limit retries in a real app
          });
      }, 2000);
    }

    function copyToClipboard(button, textSelector) {
      const card = button.closest('.card-body');
      const text = card.querySelector(textSelector).innerText;
      navigator.clipboard.writeText(text).then(() => {
        showToast('Copied to clipboard!');
      }, (err) => {
        console.error('Could not copy text: ', err);
        showToast('Failed to copy to clipboard.');
      });
    }

    function deleteHistoryItem(button) {
      const card = button.closest('.card');
      const id = card.getAttribute('data-id');
      fetch(`/history/${id}`, {
        method: 'DELETE',
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          card.remove();
          showToast('History item deleted.');
        } else {
          showToast('Failed to delete history item.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast('An error occurred while deleting the history item.');
      });
    }
  </script>
{% endblock %}
